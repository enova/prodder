




















Feature: Commiting updated dumps to a project's repository

  Background:                                                  # features/commit.feature:3
    Given a prodder config in "prodder.yml" with project: blog # features/step_definitions/prodder_steps.rb:77
    And a "blog" git repository                                # features/commit.feature:5
    And I successfully run `prodder init -c prodder.yml`       # aruba-2.3.3/lib/aruba/cucumber/command.rb:10
    And I successfully run `prodder dump -c prodder.yml`       # aruba-2.3.3/lib/aruba/cucumber/command.rb:10

  Scenario: Structure, seed, quality_checks, permissions and settings files not yet tracked # features/commit.feature:9
    When I run `prodder commit -c prodder.yml`                                              # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then 1 commit by "prodder auto-commit" should be in the "blog" repository               # features/step_definitions/git_steps.rb:31
    And the file "db/structure.sql" should now be tracked                                   # features/commit.feature:12
    And the file "db/seeds.sql" should now be tracked                                       # features/commit.feature:13
    And the file "db/quality_checks.sql" should now be tracked                              # features/commit.feature:14
    And the file "db/permissions.sql" should now be tracked                                 # features/commit.feature:15
    And the file "db/settings.sql" should now be tracked                                    # features/commit.feature:16

  Scenario: No changes to any file                                            # features/commit.feature:18
    When I run `prodder commit -c prodder.yml`                                # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then 1 commit by "prodder auto-commit" should be in the "blog" repository # features/step_definitions/git_steps.rb:31
    When I run `prodder dump -c prodder.yml`                                  # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    And I run `prodder commit -c prodder.yml`                                 # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then 1 commit by "prodder auto-commit" should be in the "blog" repository # features/step_definitions/git_steps.rb:31

  Scenario: Changes only to the structure                                                                   # features/commit.feature:25
    When I run `prodder commit -c prodder.yml`                                                              # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then 1 commit by "prodder auto-commit" should be in the "blog" repository                               # features/step_definitions/git_steps.rb:31
    When I create a new table "linkbacks" in the "blog" database                                            # features/commit.feature:28
    And I run `prodder dump -c prodder.yml`                                                                 # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    And I run `prodder commit -c prodder.yml`                                                               # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    And 2 commits by "prodder auto-commit" should be in the "blog" repository                               # features/step_definitions/git_steps.rb:31
    And the latest commit should have changed "db/structure.sql" to contain "CREATE TABLE public.linkbacks" # features/commit.feature:32
    And the latest commit should not have changed "db/seeds.sql"                                            # features/commit.feature:33
    And the latest commit should not have changed "db/quality_checks.sql"                                   # features/commit.feature:34

  Scenario: Changes only to the seed file                                        # features/commit.feature:36
    When I run `prodder commit -c prodder.yml`                                   # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then 1 commit by "prodder auto-commit" should be in the "blog" repository    # features/step_definitions/git_steps.rb:31
    When I add a new author "Marley" to the "blog" database                      # features/commit.feature:39
    And I run `prodder dump -c prodder.yml`                                      # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    And I run `prodder commit -c prodder.yml`                                    # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then 2 commits by "prodder auto-commit" should be in the "blog" repository   # features/step_definitions/git_steps.rb:31
    And the latest commit should have changed "db/seeds.sql" to contain "Marley" # features/commit.feature:43
    And the latest commit should not have changed "db/structure.sql"             # features/commit.feature:44
    And the latest commit should not have changed "db/quality_checks.sql"        # features/commit.feature:45

  Scenario: Changes to both                                                                                # features/commit.feature:47
    When I run `prodder commit -c prodder.yml`                                                             # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then 1 commit by "prodder auto-commit" should be in the "blog" repository                              # features/step_definitions/git_steps.rb:31
    When I create a new table "captchas" in the "blog" database                                            # features/commit.feature:50
    And I add a new author "Bob McBobbington" to the "blog" database                                       # features/commit.feature:51
    And I run `prodder dump -c prodder.yml`                                                                # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    And I run `prodder commit -c prodder.yml`                                                              # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then 2 commits by "prodder auto-commit" should be in the "blog" repository                             # features/step_definitions/git_steps.rb:31
    And the latest commit should have changed "db/structure.sql" to contain "CREATE TABLE public.captchas" # features/commit.feature:55
    And the latest commit should have changed "db/seeds.sql" to contain "Bob McBobbington"                 # features/commit.feature:56
    And the latest commit should not have changed "db/quality_checks.sql"                                  # features/commit.feature:57

  Scenario: Changes only to permissions                                                                                      # features/commit.feature:59
    When I run `prodder commit -c prodder.yml`                                                                               # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then 1 commit by "prodder auto-commit" should be in the "blog" repository                                                # features/step_definitions/git_steps.rb:31
    When I create a new table "gotchas" in the "blog" database                                                               # features/commit.feature:62
    When I grant all permissions on table "gotchas" in the "blog" database to "prodder"                                      # features/commit.feature:63
    And I run `prodder dump -c prodder.yml`                                                                                  # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    And I run `prodder commit -c prodder.yml`                                                                                # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    And 2 commits by "prodder auto-commit" should be in the "blog" repository                                                # features/step_definitions/git_steps.rb:31
    And the latest commit should have changed "db/permissions.sql" to contain "GRANT ALL ON TABLE public.gotchas TO prodder" # features/commit.feature:67
    And the latest commit should not have changed "db/seeds.sql"                                                             # features/commit.feature:68
    And the latest commit should not have changed "db/quality_checks.sql"                                                    # features/commit.feature:69

Feature: prodder dump

  Background:                                                  # features/dump.feature:3
    Given a prodder config in "prodder.yml" with project: blog # features/step_definitions/prodder_steps.rb:77

  Scenario: Happy path: dump structure.sql, listed seed tables, quality_checks.sql, permissions.sql and settings.sql # features/dump.feature:6
    When I run `prodder dump -c prodder.yml`                                                                         # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 0                                                                                 # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the workspace file "blog/db/structure.sql" should match /CREATE TABLE public.posts/                          # features/step_definitions/prodder_steps.rb:65
    And the workspace file "blog/db/structure.sql" should match /CREATE TABLE public.authors/                        # features/step_definitions/prodder_steps.rb:65
    And the workspace file "blog/db/seeds.sql" should match /COPY public.posts/                                      # features/step_definitions/prodder_steps.rb:65
    And the workspace file "blog/db/seeds.sql" should match /COPY public.authors/                                    # features/step_definitions/prodder_steps.rb:65
    And the workspace file "blog/db/quality_checks.sql" should match /CREATE TRIGGER /                               # features/step_definitions/prodder_steps.rb:65
    And the workspace file "blog/db/permissions.sql" should match /GRANT /                                           # features/step_definitions/prodder_steps.rb:65
    And the workspace file "blog/db/settings.sql" should match /ALTER DATABASE /                                     # features/step_definitions/prodder_steps.rb:65

  Scenario: Include specified users, exclude other login roles from permissions dump # features/dump.feature:17
    When I run `prodder dump -c prodder.yml`                                         # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 0                                                 # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the workspace file "blog/db/permissions.sql" should not match /exclude_this/ # features/step_definitions/prodder_steps.rb:69
    And the workspace file "blog/db/permissions.sql" should match /include_this/     # features/step_definitions/prodder_steps.rb:65

  Scenario: Roles missing ACL must be created, modified and granted if they're granted to non-login/included users               # features/dump.feature:23
    When I run `prodder dump -c prodder.yml`                                                                                     # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 0                                                                                             # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the workspace file "blog/db/permissions.sql" should match /create_role_if_not_exists\('prodder__blog_prod:read_only'\);/ # features/step_definitions/prodder_steps.rb:65
    And the workspace file "blog/db/permissions.sql" should match /ALTER ROLE "prodder__blog_prod:read_only" WITH NOSUPERUSER/   # features/step_definitions/prodder_steps.rb:65
    And the workspace file "blog/db/permissions.sql" should match /GRANT "prodder__blog_prod:read_only" TO "prodder"/            # features/step_definitions/prodder_steps.rb:65

  Scenario: Roles are created smartly based on connected components in structure                             # features/dump.feature:30
    When I run `prodder dump -c prodder.yml`                                                                 # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 0                                                                         # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the workspace file "blog/db/permissions.sql" should not match /create_role_if_not_exists\('_92b'\);/ # features/step_definitions/prodder_steps.rb:69
    And the workspace file "blog/db/permissions.sql" should not match /create_role_if_not_exists\('_93b'\);/ # features/step_definitions/prodder_steps.rb:69
    And the workspace file "blog/db/permissions.sql" should not match /ALTER ROLE "_92b" WITH/               # features/step_definitions/prodder_steps.rb:69
    And the workspace file "blog/db/permissions.sql" should not match /ALTER ROLE "_93b" WITH/               # features/step_definitions/prodder_steps.rb:69
    And the workspace file "blog/db/permissions.sql" should not match /GRANT "_92b" TO "_93b"/               # features/step_definitions/prodder_steps.rb:69

  #TODO: Not sure how to test this
  Scenario: All loginable (are there other kinds?) superusers are dumped # features/dump.feature:40

  #TODO: Not sure how to test this
  Scenario: Exhaustively test ACL # features/dump.feature:42

  Scenario: Valid until option is quoted                                             # features/dump.feature:44
    When I run `prodder dump -c prodder.yml`                                         # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 0                                                 # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the workspace file "blog/db/permissions.sql" should match /VALID UNTIL '.*'/ # features/step_definitions/prodder_steps.rb:65

  Scenario: Exclude passwords from permissions dump                                   # features/dump.feature:49
    When I run `prodder dump -c prodder.yml`                                          # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 0                                                  # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the workspace file "blog/db/permissions.sql" should not match /PASSWORD '.*'/ # features/step_definitions/prodder_steps.rb:69

  Scenario: Roles are created if not existing instead of always being created                       # features/dump.feature:54
    When I run `prodder dump -c prodder.yml`                                                        # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 0                                                                # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the workspace file "blog/db/permissions.sql" should not match /CREATE ROLE \S*;/            # features/step_definitions/prodder_steps.rb:69
    And the workspace file "blog/db/permissions.sql" should match /create_role_if_not_exists\(.*\)/ # features/step_definitions/prodder_steps.rb:65

  Scenario: Exclude permissions dump if file missing                                                     # features/dump.feature:60
    Given the prodder config in "prodder.yml" does not include a permissions file for the "blog" project # features/dump.feature:61
    When I run `prodder dump -c prodder.yml`                                                             # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 0                                                                     # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    Then the workspace file "blog/db/permissions.sql" should not exist                                   # features/step_definitions/prodder_steps.rb:73

  Scenario: Exclude permissions dump if permissions object is missing                             # features/dump.feature:66
    Given the prodder config in "prodder.yml" does not include permissions for the "blog" project # features/dump.feature:67
    When I run `prodder dump -c prodder.yml`                                                      # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 0                                                              # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    Then the workspace file "blog/db/permissions.sql" should not exist                            # features/step_definitions/prodder_steps.rb:73

  Scenario Outline: Exhaustively test role creation and altering                    # features/dump.feature:72
    When I run `prodder dump -c prodder.yml`                                        # features/dump.feature:73
    Then the exit status should be 0                                                # features/dump.feature:74
    And the workspace file "blog/db/permissions.sql" should match /<role_creation>/ # features/dump.feature:75
    And the workspace file "blog/db/permissions.sql" should match /<role_altering>/ # features/dump.feature:76

    Examples: 
      |                role_creation                |                                role_altering                              |
      |                   prodder                   |                     ALTER ROLE "prodder" WITH NOSUPERUSER                 |
      |         prodder__blog_prod:read_only        |           ALTER ROLE "prodder__blog_prod:read_only" WITH NOSUPERUSER      |
      |                 include_this                |                  ALTER ROLE "include_this" WITH NOSUPERUSER               |
      |                  _90enva                    |                       ALTER ROLE "_90enva" WITH NOSUPERUSER               |
      |                   _91b                      |                       ALTER ROLE "_91b" WITH NOSUPERUSER                  |
      |                   _91qa                     |                       ALTER ROLE "_91qa" WITH NOSUPERUSER                 |
      |                   _91se                     |                       ALTER ROLE "_91se" WITH NOSUPERUSER                 |
      |                   _92qa                     |                       ALTER ROLE "_92qa" WITH NOSUPERUSER                 |
      |                   _92se                     |                       ALTER ROLE "_92se" WITH NOSUPERUSER                 |
      |                   _93se                     |                       ALTER ROLE "_93se" WITH NOSUPERUSER                 |
      |                   _94se                     |                       ALTER ROLE "_94se" WITH NOSUPERUSER                 |
      |prodder__blog_prod:permissions_test:read_only|ALTER ROLE "prodder__blog_prod:permissions_test:read_only" WITH NOSUPERUSER|
      |prodder__blog_prod:permissions_test:read_only|ALTER ROLE "prodder__blog_prod:permissions_test:read_write" WITH NOSUPERUSER|

  Scenario Outline: Exhaustively test memeberships                               # features/dump.feature:94
    When I run `prodder dump -c prodder.yml`                                     # features/dump.feature:95
    Then the exit status should be 0                                             # features/dump.feature:96
    And the workspace file "blog/db/permissions.sql" should match /<membership>/ # features/dump.feature:97

    Examples: 
      |                                         membership                                        |
      |         GRANT "prodder__blog_prod:permissions_test:read_write" TO "include_this"          |
      |                     GRANT "prodder__blog_prod:read_only" TO "prodder"                     |
      |  GRANT "prodder__blog_prod:permissions_test:read_only" TO "prodder__blog_prod:read_only"  |
      |                                GRANT "_90enva" TO "_91se"                                 |
      |                                GRANT "_90enva" TO "_91qa"                                 |
      |                                GRANT "_90enva" TO "_91b"                                  |
      |                                GRANT "_91se" TO "_92se"                                   |
      |                                GRANT "_91qa" TO "_92se"                                   |
      |                                GRANT "_91qa" TO "_92qa"                                   |
      |                                GRANT "_91b" TO "_92qa"                                    |
      |                                GRANT "_91qa" TO "_94se"                                   |
      |                                GRANT "_92se" TO "_93se"                                   |
      |                                GRANT "_93se" TO "_94se"                                   |

  Scenario: Exclude specified tables from structure dump                                           # features/dump.feature:115
    Given the prodder config in "prodder.yml" excludes the table "authors" from the dump of "blog" # features/dump.feature:116
    When I run `prodder dump -c prodder.yml`                                                       # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 0                                                               # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the workspace file "blog/db/structure.sql" should not match /CREATE TABLE authors/         # features/step_definitions/prodder_steps.rb:69

  Scenario: Verify settings file contents                                                                               # features/dump.feature:121
    Given I add a custom parameter "c.p" with value "v" in the "blog" project's database                                # features/dump.feature:122
    When I run `prodder dump -c prodder.yml`                                                                            # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the workspace file "blog/db/settings.sql" should match /ALTER DATABASE :DBNAME SET c.p=v;/                     # features/step_definitions/prodder_steps.rb:65
    And the workspace file "blog/db/settings.sql" should match /ALTER DATABASE :DBNAME SET search_path=foo,bar,public;/ # features/step_definitions/prodder_steps.rb:65

  Scenario: Verify empty db setting is quoted                                                                  # features/dump.feature:127
    Given I add a custom parameter "empty.setting" with value "" in the "blog" project's database              # features/dump.feature:128
    When I run `prodder dump -c prodder.yml`                                                                   # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the workspace file "blog/db/settings.sql" should match /ALTER DATABASE :DBNAME SET empty.setting='';/ # features/step_definitions/prodder_steps.rb:65

  Scenario: Verify whitespace db setting is quoted                                                                  # features/dump.feature:132
    Given I add a custom parameter "whitespace.setting" with value " " in the "blog" project's database             # features/dump.feature:133
    When I run `prodder dump -c prodder.yml`                                                                        # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the workspace file "blog/db/settings.sql" should match /ALTER DATABASE :DBNAME SET whitespace.setting='';/ # features/step_definitions/prodder_steps.rb:65

  Scenario: Verify db settings are chomped                                               # features/dump.feature:137
    Given I add a custom parameter "k.v" with value "z" in the "blog" project's database # features/dump.feature:138
    When I run `prodder dump -c prodder.yml`                                             # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the workspace file "blog/db/settings.sql" should not match /^\s*$/              # features/step_definitions/prodder_steps.rb:69

  Scenario: Exclude specified schemas from structure dump                                       # features/dump.feature:142
    Given the prodder config in "prodder.yml" excludes the schema "ads" from the dump of "blog" # features/dump.feature:143
    And I add a "ads" schema to the "blog" project's database                                   # features/dump.feature:144
    When I run `prodder dump -c prodder.yml`                                                    # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 0                                                            # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the workspace file "blog/db/structure.sql" should not match /CREATE SCHEMA ads/         # features/step_definitions/prodder_steps.rb:69

  Scenario: Unspecified tables are not dumped to seeds                          # features/dump.feature:149
    When I run `prodder dump -c prodder.yml`                                    # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 0                                            # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the workspace file "blog/db/seeds.sql" should not match /COPY comments/ # features/step_definitions/prodder_steps.rb:69

  Scenario: Grant/revoke/ownership are not in the structure dump                            # features/dump.feature:154
    When I run `prodder dump -c prodder.yml`                                                # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the workspace file "blog/db/structure.sql" should not match /GRANT/                # features/step_definitions/prodder_steps.rb:69
    And the workspace file "blog/db/structure.sql" should not match /ALTER TABLE.*OWNER TO/ # features/step_definitions/prodder_steps.rb:69

  Scenario: Ownership is not in the seeds dump                                # features/dump.feature:159
    When I run `prodder dump -c prodder.yml`                                  # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the workspace file "blog/db/seeds.sql" should match /Owner: -/       # features/step_definitions/prodder_steps.rb:65
    And the workspace file "blog/db/seeds.sql" should not match /Owner: [^-]/ # features/step_definitions/prodder_steps.rb:69

  Scenario: Verify quality_checks file contents                                                                                                    # features/dump.feature:164
    Given I add a foreign key from table "posts" and column "author_id" to table "authors" and column "author_id" in the "blog" project's database # features/dump.feature:165
    When I run `prodder dump -c prodder.yml`                                                                                                       # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the workspace file "blog/db/quality_checks.sql" should match /ADD CONSTRAINT .* FOREIGN KEY/                                              # features/step_definitions/prodder_steps.rb:65
    Given I add an index to table "posts" on column "author_id" in the "blog" project's database                                                   # features/dump.feature:168
    When I run `prodder dump -c prodder.yml`                                                                                                       # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the workspace file "blog/db/quality_checks.sql" should match /CREATE INDEX /                                                              # features/step_definitions/prodder_steps.rb:65

  Scenario: Maintaining quality checks directly in the structure file                                                                            # features/dump.feature:172
    Given the prodder config in "prodder.yml" does not include a quality check file for the "blog" project                                       # features/dump.feature:173
    And I add a foreign key from table "posts" and column "author_id" to table "authors" and column "author_id" in the "blog" project's database # features/dump.feature:174
    When I run `prodder dump -c prodder.yml`                                                                                                     # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the workspace file "blog/db/quality_checks.sql" should not exist                                                                        # features/step_definitions/prodder_steps.rb:73
    And the workspace file "blog/db/structure.sql" should match /ADD CONSTRAINT .* FOREIGN KEY/                                                  # features/step_definitions/prodder_steps.rb:65

  Scenario: Projects can use a YAML file to specify their seed tables                                 # features/dump.feature:179
    Given the prodder config in "prodder.yml" says to read the "blog" seed tables from "db/seeds.yml" # features/dump.feature:180
    And the "blog" file "db/seeds.yml" contains:                                                      # features/dump.feature:181
      """
      - posts
      """
    When I run `prodder dump -c prodder.yml`                                                          # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 0                                                                  # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the workspace file "blog/db/seeds.sql" should match /COPY public.posts/                       # features/step_definitions/prodder_steps.rb:65
    But the workspace file "blog/db/seeds.sql" should not match /COPY public.authors/                 # features/step_definitions/prodder_steps.rb:69

  Scenario: YAML file listing seed tables does not exist                                              # features/dump.feature:190
    Given the prodder config in "prodder.yml" says to read the "blog" seed tables from "db/seeds.yml" # features/dump.feature:191
    But the "blog" file "db/seeds.yml" does not exist                                                 # features/dump.feature:192
    When I run `prodder dump -c prodder.yml`                                                          # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 1                                                                  # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the output should contain "No such file: blog/db/seeds.yml"                                   # aruba-2.3.3/lib/aruba/cucumber/command.rb:136

  @restore-perms
  Scenario: pg_dump failed                                                  # features/dump.feature:198
    Given the "prodder" role can not read from the "blog" database's tables # features/dump.feature:199
    When I run `prodder dump -c prodder.yml`                                # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 1                                        # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the output should contain "permission denied"                       # aruba-2.3.3/lib/aruba/cucumber/command.rb:136


Feature: prodder init

  Background:                                                  # features/init.feature:3
    Given a prodder config in "prodder.yml" with project: blog # features/step_definitions/prodder_steps.rb:77
    And a "blog" git repository                                # features/init.feature:5

  Scenario: Clone a project                                     # features/init.feature:7
    When I run `prodder init -c prodder.yml`                    # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 0                            # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And a directory named "prodder-workspace/blog" should exist # aruba-2.3.3/lib/aruba/cucumber/file.rb:114
    And the workspace file "blog/README" should match /Read me/ # features/step_definitions/prodder_steps.rb:65

  Scenario: Update pre-existing repository on re-initializing                    # features/init.feature:13
    Given I run `prodder init -c prodder.yml`                                    # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    And a new commit is already in the "blog" git repository                     # features/init.feature:15
    When I run `prodder init -c prodder.yml`                                     # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the new commit should be in the workspace copy of the "blog" repository # features/init.feature:17

  Scenario: Can't clone repository (no such repo, permissions, whatever)  # features/init.feature:19
    Given I deleted the "blog" git repository                             # features/init.feature:20
    When I run `prodder init -c prodder.yml`                              # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 1                                      # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the output should contain "Failed to run 'git clone ./repos/blog" # aruba-2.3.3/lib/aruba/cucumber/command.rb:136
    And the output should match /repository.*does not exist/              # aruba-2.3.3/lib/aruba/cucumber/command.rb:317

Feature: Configuration lint
  In order to simplify later error handling and hopefully provide
  rapid feedback on configuration issues, the config file is always
  run through a linting process to ensure sanity before any other
  operations are performed.

  See spec/config_spec for a more detailed test of linting. This
  test only ensures that the CLI reports lint failures reasonably.

  Background:                                                               # features/lint.feature:10
    Given a prodder config in "prodder.yml" with project: store             # features/step_definitions/prodder_steps.rb:77
    And no-op versions of these bins are available on my PATH: pg_dump, git # features/lint.feature:12

  Scenario: One of the required project config keys is missing # features/lint.feature:14
    But the "store/db/name" key is missing from "prodder.yml"  # features/lint.feature:15
    When I run `prodder ls -c prodder.yml`                     # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 1                           # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the output should contain:                             # aruba-2.3.3/lib/aruba/cucumber/command.rb:226
      """
      Missing required configuration key: store/db/name

      Example configuration:
      """
    And the output should contain the example config contents  # features/step_definitions/prodder_steps.rb:61

  Scenario: pg_dump is not available            # features/lint.feature:26
    Given "pg_dump" is not available on my PATH # features/lint.feature:27
    When I run `prodder ls -c prodder.yml`      # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 1            # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the output should contain:              # aruba-2.3.3/lib/aruba/cucumber/command.rb:226
      """
      `pg_dump` could not be found on your $PATH.

      Current PATH:
      """

  Scenario: git is not available            # features/lint.feature:37
    Given "git" is not available on my PATH # features/lint.feature:38
    When I run `prodder ls -c prodder.yml`  # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 1        # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the output should contain:          # aruba-2.3.3/lib/aruba/cucumber/command.rb:226
      """
      `git` could not be found on your $PATH.

      Current PATH:
      """

Feature: Basic CLI usage

  Scenario: prodder help                       # features/prodder.feature:3
    When I run `prodder help`                  # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the output should contain "Commands:" # aruba-2.3.3/lib/aruba/cucumber/command.rb:136

  Scenario: No config file supplied                             # features/prodder.feature:7
    When I run `prodder`                                        # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the output should contain "required option '--config'" # aruba-2.3.3/lib/aruba/cucumber/command.rb:136

  Scenario: Config file not found                                                   # features/prodder.feature:11
    When I run `prodder init -c not-there.yml`                                      # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the output should contain exactly "Config file not found: not-there.yml\n" # aruba-2.3.3/lib/aruba/cucumber/command.rb:150
    And the exit status should be 1                                                 # aruba-2.3.3/lib/aruba/cucumber/command.rb:347

  Scenario: Malformed config file           # features/prodder.feature:16
    Given a file named "broken.yml" with:   # aruba-2.3.3/lib/aruba/cucumber/file.rb:28
      """
      %this IS NOT VALID YAML
      """
    When I run `prodder init -c broken.yml` # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the output should contain:         # aruba-2.3.3/lib/aruba/cucumber/command.rb:226
      """
      Invalid YAML in config file broken.yml. Current file contents:

      %this IS NOT VALID YAML
      """

  Scenario: No database defined on project        # features/prodder.feature:29
    Given a file named "prodder.yml" with:        # aruba-2.3.3/lib/aruba/cucumber/file.rb:28
      """
      blog:
        structure_file: db/structure.sql
        seed_file: db/seeds.sql
        quality_check_file: db/quality_checks.sql
        git:
          origin: git@github.com:pd/blog.git
          author: prodder auto-commit <pd+prodder@krh.me>
      """
    When I run `prodder dump blog -c prodder.yml` # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the output should contain:               # aruba-2.3.3/lib/aruba/cucumber/command.rb:226
      """
      Missing required configuration key: blog/db

      Example configuration:
      blog:
        structure_file: db/structure.sql
        seed_file: db/seeds.sql
        quality_check_file: db/quality_checks.sql
        git:
          origin: git@github.com:your/repo.git
          author: prodder <prodder@example.com>
        db:
          name: database_name
          host: database.server.example.com
          user: username
          password: password
          tables:
            - posts
            - authors
      """

  Scenario: Projects named not defined in config file               # features/prodder.feature:63
    Given a prodder config in "prodder.yml" with project: store     # features/step_definitions/prodder_steps.rb:77
    When I run `prodder init blog api -c prodder.yml`               # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the output should contain "Project not defined: blog, api" # aruba-2.3.3/lib/aruba/cucumber/command.rb:136

  Scenario: Listing projects                                           # features/prodder.feature:68
    Given a prodder config in "prodder.yml" with projects: store, blog # features/step_definitions/prodder_steps.rb:77
    When I run `prodder ls -c prodder.yml`                             # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the output should contain exactly:                            # aruba-2.3.3/lib/aruba/cucumber/command.rb:240
      """
      store
      blog

      """

Feature: prodder push

  Background:                                                  # features/push.feature:3
    Given a prodder config in "prodder.yml" with project: blog # features/step_definitions/prodder_steps.rb:77
    And a "blog" git repository                                # features/push.feature:5
    And I successfully run `prodder init -c prodder.yml`       # aruba-2.3.3/lib/aruba/cucumber/command.rb:10
    And I successfully run `prodder dump -c prodder.yml`       # aruba-2.3.3/lib/aruba/cucumber/command.rb:10
    And I successfully run `prodder commit -c prodder.yml`     # aruba-2.3.3/lib/aruba/cucumber/command.rb:10

  Scenario: Changes are pushed upstream                    # features/push.feature:10
    When I successfully run `prodder push -c prodder.yml`  # aruba-2.3.3/lib/aruba/cucumber/command.rb:10
    Then the exit status should be 0                       # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    Then the new commit should be in the remote repository # features/step_definitions/git_steps.rb:62

  Scenario: Push fails due to permissions                        # features/push.feature:15
    Given the "blog" git repository does not allow pushing to it # features/push.feature:16
    When I run `prodder push -c prodder.yml`                     # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 1                             # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the output should contain "remote rejected"              # aruba-2.3.3/lib/aruba/cucumber/command.rb:136

  Scenario: Push fails due to non-fast-forward                 # features/push.feature:21
    Given a new commit is already in the "blog" git repository # features/push.feature:22
    When I run `prodder push -c prodder.yml`                   # aruba-2.3.3/lib/aruba/cucumber/command.rb:5
    Then the exit status should be 1                           # aruba-2.3.3/lib/aruba/cucumber/command.rb:347
    And the output should contain "Refusing to push to remote" # aruba-2.3.3/lib/aruba/cucumber/command.rb:136

73 scenarios (30 undefined, 43 passed)
397 steps (115 skipped, 64 undefined, 218 passed)
0m16.961s

You can implement step definitions for undefined steps with these snippets:

Given('a {string} git repository') do |string|
  pending # Write code here that turns the phrase above into concrete actions
end

Then('the file {string} should now be tracked') do |string|
  pending # Write code here that turns the phrase above into concrete actions
end

When('I create a new table {string} in the {string} database') do |string, string2|
  pending # Write code here that turns the phrase above into concrete actions
end

When('the latest commit should have changed {string} to contain {string}') do |string, string2|
  pending # Write code here that turns the phrase above into concrete actions
end

When('the latest commit should not have changed {string}') do |string|
  pending # Write code here that turns the phrase above into concrete actions
end

When('I add a new author {string} to the {string} database') do |string, string2|
  pending # Write code here that turns the phrase above into concrete actions
end

Then('the latest commit should have changed {string} to contain {string}') do |string, string2|
  pending # Write code here that turns the phrase above into concrete actions
end

Then('the latest commit should not have changed {string}') do |string|
  pending # Write code here that turns the phrase above into concrete actions
end

When('I grant all permissions on table {string} in the {string} database to {string}') do |string, string2, string3|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('the prodder config in {string} does not include a permissions file for the {string} project') do |string, string2|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('the prodder config in {string} does not include permissions for the {string} project') do |string, string2|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('the prodder config in {string} excludes the table {string} from the dump of {string}') do |string, string2, string3|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('I add a custom parameter {string} with value {string} in the {string} project's database') do |string, string2, string3|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('the prodder config in {string} excludes the schema {string} from the dump of {string}') do |string, string2, string3|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('I add a {string} schema to the {string} project's database') do |string, string2|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('I add a foreign key from table {string} and column {string} to table {string} and column {string} in the {string} project's database') do |string, string2, string3, string4, string5|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('I add an index to table {string} on column {string} in the {string} project's database') do |string, string2, string3|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('the prodder config in {string} does not include a quality check file for the {string} project') do |string, string2|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('the prodder config in {string} says to read the {string} seed tables from {string}') do |string, string2, string3|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('the {string} file {string} contains:') do |string, string2, doc_string|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('the {string} file {string} does not exist') do |string, string2|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('the {string} role can not read from the {string} database's tables') do |string, string2|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('a new commit is already in the {string} git repository') do |string|
  pending # Write code here that turns the phrase above into concrete actions
end

Then('the new commit should be in the workspace copy of the {string} repository') do |string|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('I deleted the {string} git repository') do |string|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('no-op versions of these bins are available on my PATH: pg_dump, git') do
  pending # Write code here that turns the phrase above into concrete actions
end

Given('the {string} key is missing from {string}') do |string, string2|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('{string} is not available on my PATH') do |string|
  pending # Write code here that turns the phrase above into concrete actions
end

Given('the {string} git repository does not allow pushing to it') do |string|
  pending # Write code here that turns the phrase above into concrete actions
end

┌──────────────────────────────────────────────────────────────────────────────┐
│ Share your Cucumber Report with your team at https://reports.cucumber.io     │
│                                                                              │
│ Command line option:    --publish                                            │
│ Environment variable:   CUCUMBER_PUBLISH_ENABLED=true                        │
│ cucumber.yml:           default: --publish                                   │
│                                                                              │
│ More information at https://cucumber.io/docs/cucumber/environment-variables/ │
│                                                                              │
│ To disable this message, specify CUCUMBER_PUBLISH_QUIET=true or use the      │
│ --publish-quiet option. You can also add this to your cucumber.yml:          │
│ default: --publish-quiet                                                     │
└──────────────────────────────────────────────────────────────────────────────┘


















